function load(t,e,a,n){t&&console.log(t),Mobility.data=[e,o,a];var r={},o={},i=topojson.mesh(n,n.objects.states,function(t,e){return t!==e}),s=topojson.feature(n,n.objects.commute);e.forEach(function(t){t.intercept=+t.intercept,t.slope=+t.slope,t.population=+t.pop2000usda,t.name=t["CZ.Name"],t.state=t.State,t.cz=t.CZ,r[t.cz]=t,t.probabilities=[],t.ranks=[],t.positions=[];for(var e=0;5>e;e++){t.probabilities[e]=[];for(var a=0;5>a;a++)t.probabilities[e][a]=+t["prob_kidQ"+(a+1)+"_parQ"+(e+1)]}}),Mobility.dispatch.load(e,o,a,r,s,i)}var Mobility={};Mobility.bigAssetsPath="undefined"==typeof _BIG_ASSETS?"http://graphics8.nytimes.com/newsgraphics/2013/07/02/inequality/assets/":_BIG_ASSETS,Mobility.containers={map:".articleSpanImage",me:".g-me",mobileme:".g-mobileme",bump:".g-bump"},Mobility.dispatch=d3.dispatch("load"),Mobility.formatRank=function(t){var e,a=parseInt(t,10),n=a%10;return e=1==n&&11!=a?a+"st":2==n&&12!=a?a+"nd":3==n&&13!=a?a+"rd":a+"th"},Mobility.color=d3.scale.linear().domain([.35,.49,.5,.51,.65]).range(["red","#F9C79E","#EBE3D7","#A6C5C6","green"]),Mobility.quintileColor=d3.scale.ordinal().domain([0,1,2,3,4]).range(["orange","#ccc","#ccc","#ccc","royalblue"]),Mobility.rankColor=d3.scale.linear().domain([0,100,200]).range(["red","orange","white"]),Mobility.compareColor=d3.scale.linear().domain([-.1,0,.1,1]).range(["red","white","green","green"]),Mobility.mapColor=d3.scale.linear().domain([.04,.07,.12,.18,.35]).range(["#B63132","#ECCB7B","#FDF6A3","#CCDBA3","#276c91"]),Mobility.postalLook={AL:"Ala.",AK:"Alaska",AZ:"Ariz.",AR:"Ark.",CA:"Calif.",CO:"Colo.",CT:"Conn.",DE:"Del.",DC:"D.C.",FL:"Fla.",GA:"Ga.",HI:"Hawaii",ID:"Idaho",IL:"Ill.",IN:"Ind.",IA:"Iowa",KS:"Kan.",KY:"Ky.",LA:"La.",ME:"Me.",MD:"Md.",MA:"Mass.",MI:"Mich.",MN:"Minn.",MS:"Miss.",MO:"Mo.",MT:"Mont.",NE:"Neb.",NV:"Nev.",NH:"N.H.",NJ:"N.J.",NM:"N.M.",NY:"N.Y.",NC:"N.C.",ND:"N.D.",OH:"Ohio",OK:"Okla.",OR:"Ore.",PA:"Pa.",RI:"R.I.",SC:"S.C.",SD:"S.D.",TN:"Tenn.",TX:"Tex.",UT:"Utah",VT:"Vt.",VA:"Va.",WA:"Wash.",WV:"W.Va.",WI:"Wis.",WY:"Wyo."},Mobility.mapCompareColor=d3.scale.threshold().domain([-.06,-.04,-.02,0,.02,.04,.06]).range(["#fee391","#fec44f","#fe9929","#d95f0e"].reverse().concat(["#dadaeb","#bcbddc","#9e9ac8","#756bb1"])),queue().defer(d3.csv,Mobility.bigAssetsPath+"/data-7-14/czdata.csv").defer(d3.csv,Mobility.bigAssetsPath+"/data-7-14/crosswalk.csv").defer(d3.json,Mobility.bigAssetsPath+"/data-7-14/commute.json").await(load),Mobility.dispatch.on("load.map",function(t,e,a,n,r,o){var i=d3.format(".1%"),s={top:10,right:10,bottom:20,left:10},l=945-s.left-s.right,c=500-s.top-s.bottom,p=d3.geo.albersUsa().scale(1e3).translate([l/2,c/2]),d=d3.geo.path().projection(p),u=d3.select(Mobility.containers.map).classed("g-map",!0).html(""),g=u.append("svg").attr("width",l+s.left+s.right).attr("height",c+s.top+s.bottom).append("g").attr("transform","translate("+s.left+","+s.top+")"),h=r,f={};t.forEach(function(t){f[t.cz]=t}),h.features.forEach(function(t){t.properties=f[t.id]});var m=g.append("g"),v=m.append("g"),y=d3.select(".g-map").append("div").classed("g-map-tooltip",!0),b=y.append("div").classed("g-place-tt",!0),x=v.selectAll(".cz").data(h.features).enter().append("path").attr("d",d).attr("id",function(t){return"z"+t.id}).attr("class","cz").style("fill",function(t){var e=t.properties.probabilities[0][4];return isNaN(e)?null:Mobility.mapColor(e)});x.on("mouseover",function(t){y.classed("g-hovering-tooltip",!0),g.selectAll(".g-hover").classed("g-hover",!1),d3.select(this).classed("g-hover",!0),m.node().appendChild(this);var e=f[t.id]["CZ.Name"];f[t.id].State,e="Washington DC"==e?"Washington":e;var a=f[t.id].prob_kidQ5_parQ1,n=i(a)+" for children from the "+e+" area";isNaN(a)&&(n="Data not available for this area"),b.text(n)}).on("mouseout",function(){d3.select(this).classed("g-hover",!1),v.node().appendChild(this)}).on("mousemove",function(){var t=d3.mouse(g.node());y.style("left",t[0]+"px").style("top",t[1]-35+"px")}),g.on("mouseout",function(){y.classed("g-hovering-tooltip",!1),g.selectAll(".g-hover").classed("g-hover",!1),d3.select(".g-map-tooltip").classed("g-hovering-tooltip",!1)}),m.append("path").datum(o).attr("d",d).attr("class","state");var C=g.append("g").attr("class","g-map-key").attr("transform","translate(-10,130)"),k=[4,10,15,20,35];blockWidth=16,blockSpace=5;var M=C.selectAll("g.keyThings").data(k.reverse()).enter().append("g").attr("class","keyThings").attr("transform",function(t,e){return"translate(0,"+(blockWidth+blockSpace)*e+")"});M.append("rect").attr("height",function(){return blockWidth}).attr("width",function(){return blockWidth}).style("fill",function(t){return Mobility.mapColor(t/100)}).attr("x",0),M.append("text").text(function(t){return t+"%"}).attr("x",28).attr("y",blockWidth/2+4);var w=u.append("div").attr("class","g-headlines");w.append("h3").html("The chance a child raised in the bottom fifth<br>rose to the<br>top fifth").style("width","125px").style("top","10px").style("position","absolute");var A=[{NAME:"Atlanta",lat:-84.40317264,"long":33.75951318,cz:9100},{NAME:"Boston",lat:-71.08912164,"long":42.32160018,cz:20500},{NAME:"Chicago",lat:-87.67936164,"long":41.84067618,cz:24300,extraY:12},{NAME:"Houston",lat:-95.38317264,"long":29.76289218,cz:32e3},{NAME:"L.A.",lat:-118.3759856,"long":34.08615018,cz:38300},{NAME:"New York",lat:-73.91792964,"long":40.70423718,cz:19400},{NAME:"Salt Lake City",lat:-111.8926196,"long":40.75470018,cz:36100},{NAME:"S.F.",lat:-122.4373886,"long":37.75987818,cz:37800,extraY:-14},{NAME:"Charlotte",lat:-80.82923,"long":35.20719,cz:900}],N=g.selectAll("g.city").data(A).enter().append("svg:g").attr("class","node").attr("transform",function(t){return"translate("+p([t.lat,t.long])+")"}),S=805,R=["Atlanta","Boston","New York","D.C.","Charlotte"];midCites=["S.F.","Chicago"],rightCities=["L.A."],N.append("circle").attr("r",2.5).attr("class","g-map-circle");var I=d3.format(".1f");N.append("text").text(function(t){var e=100*f[t.cz].prob_kidQ5_parQ1;return t.NAME+": "+I(e)+"%"}).attr("class","cityLabel").attr("x",function(t){return R.indexOf(t.NAME)>=0?S-p([t.lat,t.long])[0]+5+(t.extraY||0):(rightCities.indexOf(t.NAME)>=0?-6:6)+(t.extraX||0)}).attr("y",function(t){return t.extraY||0}).classed("midLabel",function(t){return midCites.indexOf(t.NAME)>=0}).classed("rightLabel",function(t){return rightCities.indexOf(t.NAME)>=0}),N.append("line").filter(function(t){return R.indexOf(t.NAME)>=0}).attr("x1",0).attr("y1",0).attr("x2",function(t){return S-p([t.lat,t.long])[0]}).attr("y2",0).style("stroke","rgb(0,0,0)").style("stroke-width",.5),g.selectAll(".g-note").data("In areas like Atlanta,\nupward mobility appears\nto be substantially lower\nthan in any other rich\ncountry.".split("\n")).enter().append("text").classed("g-text-annotation",!0).attr("x",S+4).attr("y",340).attr("dy",function(t,e){return 1.3*e+"em"}).text(function(t){return t}),g.selectAll(".g-note").data("The top fifth is\nequal to family income\nof more than $70,000\nfor the child by age 30,\nor more than $100,000\nby age 45.".split("\n")).enter().append("text").classed("g-text-annotation-tiny",!0).attr("x",-10).attr("y",300).attr("dy",function(t,e){return 1.3*e+"em"}).text(function(t){return t})}),Mobility.dispatch.on("load.me",function(t,e,a,n,r,o){function i(t){return t+="",t.substr(-Math.min(t.length,2))>3&&21>t.substr(-Math.min(t.length,2))?"th":["th","st","nd","rd","th"][Math.min(Number(t)%10,4)]}function s(t){return a[t-1].pmean}var l,c=d3.dispatch("ready","parentRankChange","cityChange","dataChange"),p=d3.select(Mobility.containers.me),d=p.append("div").attr("class","g-me-map"),u=p.append("div").attr("class","g-outcomes"),g=p.append("div").attr("class","g-headlines"),h={top:15,right:0,bottom:20,left:70},f=515-h.left-h.right,m=260-h.top-h.bottom,v=f/3,y=u.append("svg").attr("width",f+h.left+h.right).attr("height",m+h.top+h.bottom).append("g").attr("transform","translate("+h.left+","+h.top+")"),b=d3.scale.linear().domain([1,100]).range([m,0]).clamp(!0),x=function(t){return"$"+Math.round(t/1e3)+"K"};formatPercent=d3.format("%"),formatNum=d3.format("f"),formatPercentile=function(t){return isNaN(t)?"Data not available for this area":formatNum(100*t)+i(formatNum(100*t))+" percentile"},formatppchg=function(t){if(isNaN(t))return"Data not available for this area";var e="";return 0>t&&(e="below"),t>0&&(e="above"),0==t&&(e="the same as"),formatNum(100*t)+" pts. "+e+" avg."};var C,k=9100,M=10,w=4,A=[1,20,40,60,80,99];p.append("div").attr("class","g-note").html("Data is based on the experiences of children who are now around age 30, and their parents&rsquo; incomes, in today&rsquo;s dollars, from the late 1990s."),c.on("parentRankChange.data",function(t){M=Math.min(99,Math.round(t)),w=Math.floor(M/20);var e=n[k];C=isNaN(e.slope)?-1:Math.round(100*(e.intercept+e.slope*(M/100))),c.dataChange()}),c.on("cityChange.data",function(t){k=t;var e=n[k];C=isNaN(e.slope)?-1:Math.round(100*(e.intercept+e.slope*(M/100))),c.dataChange()});var N=g.append("h3").html("A child who grows up in the").style("left","130px");g.append("h3").attr("class","g-parent-headline").html("... with parents who earn in the <div class='g-parent-income'></div> percentile").style("left","400px").style("width","220px"),g.append("h3").attr("class","g-child-headline").html("... ends up, on average, in the <span class='g-child-income'></span> percentile").style("left","680px").style("width","200px"),g.append("h3").attr("class","g-na-headline").text("Data not available for this area").style("left","440px").style("top","15px").style("width","300px").style("display","none"),c.on("ready.parent",function(){var t=y.append("g"),e=t.append("g").attr("transform","translate(0, 0)"),a=e.selectAll(".tick").data(A).enter().append("g").attr("class","tick").attr("transform",function(t){return"translate(0, "+b(t)+")"});a.append("text").text(function(t){return Mobility.formatRank(t)}).attr("x",20),a.append("line").attr("x1",50).attr("x2",v-10),l=t.append("path").attr("class","g-outcome-path");var n=t.append("g").attr("class","g-parent-slider").attr("transform","translate(0, 0)"),r=n.append("rect").attr("class","g-slider-tray").attr("width",8).attr("y",-4).attr("height",m+8).attr("rx",4).attr("ry",4),o=n.append("g").attr("class","g-slider-handle");o.append("rect").attr("width",45).attr("height",16).attr("x",10).attr("y",-8).style("fill","white"),o.append("circle").attr("r",10).attr("cx",4);var i=o.append("text").attr("class","g-handle-rank-label g-handle-label").attr("transform","translate(20, 0)"),p=o.append("text").attr("class","g-handle-income-label g-handle-label").attr("transform","translate(-12, 0)");n.call(d3.behavior.drag().on("dragstart",function(){c.parentRankChange(b.invert(d3.mouse(r.node())[1])),d3.event.sourceEvent.preventDefault()}).on("drag",function(){c.parentRankChange(b.invert(d3.mouse(r.node())[1]))})),c.on("dataChange.parent",function(){o.attr("transform","translate(0, "+b(M)+")"),g.select(".g-parent-income").text(Mobility.formatRank(M)),i.text(Mobility.formatRank(M)),p.text(x(s(M)))})}),c.on("ready.child",function(){var t=y.append("g").attr("transform","translate("+v+",0)"),e=t.append("g").attr("transform","translate(0, 0)"),a=e.selectAll(".tick").data(A).enter().append("g").attr("class","tick").attr("transform",function(t){return"translate(0, "+b(t)+")"});a.append("text").text(function(t){return Mobility.formatRank(t)}).attr("x",20),a.append("line").attr("x1",50).attr("x2",v-10),t.append("rect").attr("class","g-domain").attr("width",8).attr("height",m);var n=t.append("g"),r=n.append("text").attr("class","g-handle-label").attr("transform","translate(20, 0)");n.append("path").attr("d","M0 -10L 10 0L0 10z"),c.on("dataChange.child",function(){-1===C?(n.style("display","none"),l.style("display","none"),g.select(".g-child-headline").style("display","none"),g.select(".g-parent-headline").style("display","none"),g.select(".g-na-headline").style("display",null)):(n.style("display",null),l.style("display",null),g.select(".g-child-headline").style("display",null),g.select(".g-parent-headline").style("display",null),g.select(".g-na-headline").style("display","none"),g.select(".g-child-income").text(Mobility.formatRank(C))),n.attr("transform","translate(0, "+b(C)+")"),r.text(Mobility.formatRank(C));var t=20;l.attr("d",function(){return"M60 "+b(M)+"l "+t+" 0"+"L"+(v-t)+" "+b(C)+"l"+t+" 0"})})}),c.on("ready.prob",function(){var t=d3.scale.linear().domain([0,.5]).range([0,v]),e=y.append("g").attr("transform","translate("+2*v+",0)"),a=e.append("g").attr("transform","translate(0, 0)"),r=a.selectAll(".tick").data(A).enter().append("g").attr("class","tick").attr("transform",function(t){return"translate(0, "+b(t)+")"});r.append("line").attr("x2",v-10);var o=e.selectAll(".g-bar").data(A.splice(1,5)).enter().append("g").attr("class","g-bar").attr("transform",function(t){return"translate(0, "+(b(t)+2)+")"});o.append("rect").attr("height",function(t,e){return m/5-(0===e||4===e?6:4)});var i=o.append("text").attr("y",m/5/2-4).attr("x",6);i.append("tspan").attr("class","g-income-prob"),i.append("tspan").attr("dx",3).text(function(t,e){return 4===e?" will be top earners":""}),c.on("dataChange.prob",function(){var e=n[k];-1===C?(o.data([0,0,0,0,0]),o.select("text").style("display","none")):(o.data(e.probabilities[w]),o.select("text").style("display",null)),o.select("rect").transition().duration(150).ease("linear").attr("width",function(e){return t(e)}),o.select(".g-income-prob").text(function(t){return formatPercent(t)})})}),c.on("ready.map",function(){function e(){u=!0}function a(){E[0]+=d3.event.dx,E[1]+=d3.event.dy,R.call(l)}function i(){u=!1,E=p(E)}function l(t){t.attr("transform","translate("+p(E)+")scale(3)translate("+-w[0]+","+-w[1]+")")}function p(t){var e=3,a=t[0],n=t[1],r=-w[0],o=-w[1];return[Math.min(-r*e+40,Math.max(g*(1-e)-r*e-40,a)),Math.min(-o*e+40,Math.max(h*(1-e)-o*e-40,n))]}var u,g=435,h=260,f=d3.geo.albersUsa().scale(550).translate([g/2-20,h/2]),m=d3.geo.path().projection(f),v=d3.behavior.drag().on("dragstart",e).on("drag",a).on("dragend",i),y=N.append("input").attr("id","g-city-complete").attr("name","g-city-complete").attr("class","g-search"),b=d.append("svg").attr("class","g-me-map-svg").attr("width",g).attr("height",h).style("margin-top","25px");b.append("rect").attr("width",g).attr("height",h).style("fill","none").style("pointer-events","all").on("mouseout",function(){b.selectAll(".g-hovering-tooltip").classed("g-hovering-tooltip",!1)});var C,w,A,S,R=b.append("g").attr("class","g-zoom-container"),I=r,E=[g/2,h/2],z={};t.forEach(function(t){z[t.cz]=t}),I.features.forEach(function(t){t.properties=z[t.id]});var T=R.append("g"),F=T.append("g"),D=d3.select(".g-me").append("div").classed("g-me-tooltip",!0);D.append("span").classed("g-place-tt",!0);var P=D.append("span").classed("g-ppchg-tt",!0),L=F.selectAll(".cz").data(I.features).enter().append("path").attr("d",m).attr("class","cz").on("mouseover",function(t){if(!u){b.selectAll(".g-hover").classed("g-hover",!1),d3.select(this).classed("g-hover",!0);var e=t.properties["CZ.Name"],a=t.localChildRank;e="Washington DC"==e?"Washington":e,d3.select(".g-me-tooltip .g-place-tt").text(e+" area "),P.text(formatPercentile(a)),T.node().appendChild(this),D.classed("g-hovering-tooltip",!0)}}).on("mouseout",function(){u||F.node().appendChild(this)}).on("click",function(t){d3.event.defaultPrevented||c.cityChange(t.id)}).on("mousemove",function(){var t=d3.mouse(b.node());D.style("left",t[0]+"px").style("top",t[1]+40+"px")});b.on("mouseout",function(){b.selectAll(".g-hover").classed("g-hover",!1),D.classed("g-hovering-tooltip",!1)}),T.append("path").datum(o).attr("d",m).attr("class","state");var V=R.append("g").attr("class","g-pin"),B=V.append("circle").attr("r",10);d.append("button").attr("class","g-zoom-button").style("opacity",0).text("Zoom Out").on("click",function(){var t=d.transition();b.on(".drag",null),t.select(".g-zoom-button").style("opacity",0),t.select(".g-zoom-container").attr("transform","")});var O=d.append("svg").attr("width",g).attr("height",50).attr("class","g-me-legend").style("position","absolute").style("bottom",0).style("top","345px").style("height","50px").append("g").attr("transform","translate("+.5*g+",15)"),j=d3.scale.linear().domain([-.08,.08]).range([0,.5*g]),W=d3.svg.axis().scale(j).orient("bottom").tickSize(6).tickPadding(5).tickValues(Mobility.mapCompareColor.domain()).tickFormat(function(t){return d3.format("+.0")(100*t)});O.selectAll("rect").data(Mobility.mapCompareColor.range().map(function(t,e){return{x0:e?j(Mobility.mapCompareColor.domain()[e-1]):j.range()[0],x1:4>e?j(Mobility.mapCompareColor.domain()[e]):j.range()[1],z:t}})).enter().append("rect").attr("height",6).attr("x",function(t){return t.x0}).attr("width",function(t){return t.x1-t.x0}).style("fill",function(t){return t.z}),O.call(W).selectAll(".tick text").filter(function(t){return!t}).text("Avg."),O.append("text").attr("y",-5).attr("x",g/4).style("text-anchor","middle").style("font-size","10px").text("Percentile points better or worse");var Q=d.append("text").attr("class","g-legend-head");c.on("cityChange.map",function(t){if(I.features.some(function(e){return e.id===t?C=e:void 0}),A=m.bounds(C),w=m.centroid(C),V.attr("transform","translate("+w+")"),B.attr("r",Math.max(4,Math.max(A[1][1]-A[0][1],A[1][0]-A[0][0])/2+3)),S){E=[g/2,h/2],b.call(v);var e=d.transition();e.select(".g-zoom-button").style("opacity",1),e.select(".g-zoom-container").call(l)}else S=!0;y.property("value",n[k].name+", "+Mobility.postalLook[n[k].state]+", area"),d3.select(".g-me-tooltip").classed("g-hovering-tooltip",!1)}),c.on("dataChange.map",function(){Q.html("With parents who earn "+x(s(M))+",<br>how area compares to U.S. average:"),L.style("fill",function(t){var e=t.properties.intercept+t.properties.slope*(M/100),a=.331+.338*(M/100),n=e-a;return t.ppdiff=n,t.localChildRank=e,Mobility.mapCompareColor(n)})})}),c.ready(),c.parentRankChange(M),c.cityChange(k),jQuery(function(t){jQuery.support.cors=!0,t("#g-city-complete").autocomplete({maxHeight:300,width:200,minChars:2,zIndex:9999,deferRequestBy:0,noCache:!1,autoSelectFirst:!0,ignoreParams:!0,serviceUrl:function(t){var e=t.substring(0,2);return Mobility.bigAssetsPath+"/lookups/"+e.toLowerCase()+".json"},lookupFilter:function(t,e,a){return t.value.toLowerCase().substring(0,a.length)==a?!0:!1},onSelect:function(t){c.cityChange(t.data)}})})}),Mobility.dispatch.on("load.mobileme",function(t,e,a,n){function r(t){return a[t-1].pmean}var o=d3.dispatch("ready","parentRankChange","cityChange","dataChange"),i=d3.select(Mobility.containers.mobileme),s=i.append("div").attr("class","g-outcomes"),l=i.append("div").attr("class","g-headlines"),c={top:75,right:16,bottom:20,left:30},p=320-c.left-c.right,d=700-c.top-c.bottom,u=d/5,g=s.append("svg").attr("width",p+c.left+c.right).attr("height",d+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")"),h=g.append("filter").attr("id","dropshadow").attr("height",50).attr("width",50);h.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",1.2),h.append("feOffset").attr("dy",2).attr("result","offsetblur"),h.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.2);var f=h.append("feMerge");f.append("feMergeNode"),f.append("feMergeNode").attr("in","SourceGraphic");var m=d3.scale.linear().domain([100,1]).range([p,0]).clamp(!0),v=function(t){var e,a=parseInt(t,10),n=a%10;return e=1==n&&11!=a?a+"st":2==n&&12!=a?a+"nd":3==n&&13!=a?a+"rd":a+"th"},y=function(t){return"$"+Math.round(t/1e3)+"K"};formatPercent=d3.format("%");var b,x=19400,C=10,k=4,M=[1,20,40,60,80,99];o.on("parentRankChange.data",function(t){C=Math.min(99,Math.round(t)),k=Math.floor(C/20);var e=n[x];b=Math.round(100*(e.intercept+e.slope*(C/100))),o.dataChange()}),o.on("cityChange.data",function(t){x=t;var e=n[x];b=Math.round(100*(e.intercept+e.slope*(C/100))),o.dataChange()});var w=l.append("h3").html("A child who grows up in the").style("left","130px");w.append("input").attr("value","New York, N.Y., area").attr("id","g-city-complete-mobile"),l.append("h3").html("with parents who earn in the <div class='g-income g-parent-income'></div><div class='g-parent-income-dollars'>$XXXXX</div>").classed("g-parent-text",!0),l.append("h3").html("ends up, on average, in the <div class='g-income g-child-income'></div>").classed("g-child-text",!0),l.append("h3").html("Probability of outcomes<div class='g-label'>for children raised in the same quintile and area.</div>").classed("g-probability-text",!0),o.on("ready.parent",function(){var t=g.append("g"),e=t.append("g").attr("transform","translate(0, 0)"),a=e.selectAll(".tick").data(M).enter().append("g").attr("class","tick").attr("transform",function(t){return"translate("+m(t)+", 0)"});a.append("text").text(function(t){return v(t)}).attr("y",-8).attr("text-anchor","middle"),a.append("line").attr("y1",0).attr("y2",u-10).attr("stroke-dasharray","5, 5");var n=t.append("g").attr("class","g-parent-slider").attr("transform","translate(0, 0)"),i=n.append("rect").attr("class","g-slider-tray").attr("height",8).attr("x",-4).attr("width",p+8).attr("rx",4).attr("ry",4),s=n.append("g").attr("class","g-slider-handle");s.append("circle").attr("r",15).attr("cy",3).style("filter","url(#dropshadow)"),n.call(d3.behavior.drag().on("dragstart",function(){o.parentRankChange(m.invert(d3.mouse(i.node())[0])),d3.event.sourceEvent.preventDefault()}).on("drag",function(){o.parentRankChange(m.invert(d3.mouse(i.node())[0]))})),o.on("dataChange.parent",function(){s.attr("transform","translate("+m(C)+", 0)"),l.select(".g-parent-income").text(v(C)+" percentile"),l.select(".g-parent-income-dollars").html(" &#150; "+y(r(C)))})}),o.on("ready.child",function(){var t=g.append("g").attr("transform","translate(0, "+(u-20)+")"),e=t.append("g").attr("transform","translate(0, 0)"),a=e.selectAll(".tick").data(M).enter().append("g").attr("class","tick").attr("transform",function(t){return"translate("+m(t)+",0)"});a.append("text").text(function(t){return v(t)}).attr("y",-8).attr("text-anchor","middle"),a.append("line").attr("y1",0).attr("y2",2*u-50).attr("stroke-dasharray","5, 5"),t.append("rect").attr("class","g-domain").attr("width",p).attr("height",8);var n=t.append("g");n.append("circle").attr("r",15).attr("cy",3).classed("g-mobileme-child-indicator",!0),o.on("dataChange.child",function(){n.attr("transform","translate("+m(b)+",0)"),l.select(".g-child-income").text(v(b)+" percentile")})}),o.on("ready.prob",function(){var t=80,e=d3.scale.linear().domain([0,.5]).range([0,u]),a=g.append("g").attr("transform","translate(0, "+(2*u-30)+")"),r=a.append("g").attr("transform","translate(0, 0)");r.selectAll(".tick").data(M).enter().append("g").attr("class","tick").attr("transform",function(t){return"translate("+m(t)+",0)"});var i=a.selectAll(".g-bar").data(M.splice(1,5)).enter().append("g").attr("class","g-bar").attr("transform",function(t,e){var a=0;return 4===e&&(a=3),"translate("+(m(t)+a-p/5)+",0)"});i.append("rect").attr("width",p/5-1);var s=i.append("text").attr("y",t-12).attr("x",14);s.append("tspan").attr("class","g-income-prob"),o.on("dataChange.prob",function(){var a=n[x];i.data(a.probabilities[k]),i.select("rect").transition().duration(150).ease("linear").attr("height",function(t){return e(t)}).attr("transform",function(a){return"translate(0, "+(t-e(a))+")"}),i.select(".g-income-prob").text(function(t){return formatPercent(t)})})}),jQuery("#g-city-complete-mobile").on("focus",function(){jQuery(this).val("")}).on("blur",function(){var t=n[x];jQuery(this).val(t["CZ.Name"]+", "+t.State)}),jQuery(function(t){jQuery.support.cors=!0,t("#g-city-complete-mobile").autocomplete({maxHeight:300,width:200,minChars:2,zIndex:9999,deferRequestBy:0,noCache:!1,autoSelectFirst:!0,ignoreParams:!0,serviceUrl:function(t){var e=t.substring(0,2);return Mobility.bigAssetsPath+"/lookups/"+e.toLowerCase()+".json"},lookupFilter:function(t,e,a){return t.value.toLowerCase().substring(0,a.length)==a?!0:!1},onSelect:function(t){o.cityChange(t.data)}})}),o.ready(),o.parentRankChange(C),o.cityChange(x)}),function(t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)}(function(t){"use strict";function e(a,n){var r=function(){},o=this,i={autoSelectFirst:!1,appendTo:"body",serviceUrl:null,lookup:null,onSelect:null,width:"auto",minChars:1,maxHeight:300,deferRequestBy:0,params:{},formatResult:e.formatResult,delimiter:null,zIndex:9999,type:"GET",noCache:!1,onSearchStart:r,onSearchComplete:r,containerClass:"autocomplete-suggestions",tabDisabled:!1,dataType:"text",lookupFilter:function(t,e,a){return-1!==t.value.toLowerCase().indexOf(a)},paramName:"query",transformResult:function(e){return"string"==typeof e?t.parseJSON(e):e}};o.element=a,o.el=t(a),o.suggestions=[],o.badQueries=[],o.selectedIndex=-1,o.currentValue=o.element.value,o.intervalId=0,o.cachedResponse=[],o.onChangeInterval=null,o.onChange=null,o.ignoreValueChange=!1,o.isLocal=!1,o.suggestionsContainer=null,o.options=t.extend({},i,n),o.classes={selected:"autocomplete-selected",suggestion:"autocomplete-suggestion"},o.initialize(),o.setOptions(n)}var a=function(){return{extend:function(e,a){return t.extend(e,a)},createNode:function(t){var e=document.createElement("div");return e.innerHTML=t,e.firstChild}}}(),n={ESC:27,TAB:9,RETURN:13,UP:38,DOWN:40};e.utils=a,t.Autocomplete=e,e.formatResult=function(t,e){var a=RegExp("(\\"+["/",".","*","+","?","|","(",")","[","]","{","}","\\"].join("|\\")+")","g"),n="("+e.replace(a,"\\$1")+")";return t.value.replace(RegExp(n,"gi"),'<span class="autocomplete-match">$1</span>')},e.prototype={killerFn:null,initialize:function(){var a,n=this,r="."+n.classes.suggestion,o=n.classes.selected,i=n.options;n.element.setAttribute("autocomplete","off"),n.killerFn=function(e){0===t(e.target).closest("."+n.options.containerClass).length&&(n.killSuggestions(),n.disableKillerFn())},i.width&&"auto"!==i.width||(i.width=n.el.outerWidth()),n.suggestionsContainer=e.utils.createNode('<div class="'+i.containerClass+'" style="position: absolute; display: none;"></div>'),a=t(n.suggestionsContainer),a.appendTo(i.appendTo).width(i.width),a.on("mouseover.autocomplete",r,function(){n.activate(t(this).data("index"))}),a.on("mouseout.autocomplete",function(){n.selectedIndex=-1,a.children("."+o).removeClass(o)}),a.on("click.autocomplete",r,function(){n.select(t(this).data("index"),!1)}),n.fixPosition(),window.opera?n.el.on("keypress.autocomplete",function(t){n.onKeyPress(t)}):n.el.on("keydown.autocomplete",function(t){n.onKeyPress(t)}),n.el.on("keyup.autocomplete",function(t){n.onKeyUp(t)}),n.el.on("blur.autocomplete",function(){n.onBlur()}),n.el.on("focus.autocomplete",function(){n.fixPosition()})},onBlur:function(){this.enableKillerFn()},setOptions:function(e){var n=this,r=n.options;a.extend(r,e),n.isLocal=t.isArray(r.lookup),n.isLocal&&(r.lookup=n.verifySuggestionsFormat(r.lookup)),t(n.suggestionsContainer).css({"max-height":r.maxHeight+"px",width:r.width+"px","z-index":r.zIndex})},clearCache:function(){this.cachedResponse=[],this.badQueries=[]},clear:function(){this.clearCache(),this.currentValue=null,this.suggestions=[]},disable:function(){this.disabled=!0},enable:function(){this.disabled=!1},fixPosition:function(){var e,a=this;"body"===a.options.appendTo&&(e=a.el.offset(),t(a.suggestionsContainer).css({top:e.top+a.el.outerHeight()+"px",left:e.left+"px"}))},enableKillerFn:function(){var e=this;t(document).on("click.autocomplete",e.killerFn)},disableKillerFn:function(){var e=this;t(document).off("click.autocomplete",e.killerFn)},killSuggestions:function(){var t=this;t.stopKillSuggestions(),t.intervalId=window.setInterval(function(){t.hide(),t.stopKillSuggestions()},300)},stopKillSuggestions:function(){window.clearInterval(this.intervalId)},onKeyPress:function(t){var e=this;if(!e.disabled&&!e.visible&&t.keyCode===n.DOWN&&e.currentValue)return e.suggest(),void 0;if(!e.disabled&&e.visible){switch(t.keyCode){case n.ESC:e.el.val(e.currentValue),e.hide();break;case n.TAB:case n.RETURN:if(-1===e.selectedIndex)return e.moveDown(),e.select(e.selectedIndex,t.keyCode===n.RETURN),void 0;if(e.select(e.selectedIndex,t.keyCode===n.RETURN),t.keyCode===n.TAB&&this.options.tabDisabled===!1)return;break;case n.UP:e.moveUp();break;case n.DOWN:e.moveDown();break;default:return}t.stopImmediatePropagation(),t.preventDefault()}},onKeyUp:function(t){var e=this;if(!e.disabled){switch(t.keyCode){case n.UP:case n.DOWN:return}clearInterval(e.onChangeInterval),e.currentValue!==e.el.val()&&(e.options.deferRequestBy>0?e.onChangeInterval=setInterval(function(){e.onValueChange()},e.options.deferRequestBy):e.onValueChange())}},onValueChange:function(){var t,e=this;return clearInterval(e.onChangeInterval),e.currentValue=e.element.value,t=e.getQuery(e.currentValue),e.selectedIndex=-1,e.ignoreValueChange?(e.ignoreValueChange=!1,void 0):(t.length<e.options.minChars?e.hide():e.getSuggestions(t),void 0)},getQuery:function(e){var a,n=this.options.delimiter;return n?(a=e.split(n),t.trim(a[a.length-1])):t.trim(e)},filterSuggestions:function(e){var a=this,n=e.toLowerCase(),r=a.options.lookupFilter;a.suggestions=t.grep(a.suggestions,function(t){return r(t,e,n)})},getSuggestions:function(e){var a,n=this,r=n.options;r.serviceUrl;var o=r.serviceUrl.call(n.element,e);if(a=n.isLocal?n.options.lookup:n.cachedResponse[o],a&&t.isArray(a.suggestions))n.suggestions=a.suggestions,n.filterSuggestions(e),n.suggest();else if(!n.isBadQuery(o)){if(r.onSearchStart.call(n.element,r.params)===!1)return;window.d3?d3.json(o,function(t,a){t?n.addBadRequest(o):(n.processResponse(a,o),r.onSearchComplete.call(n.element,e))}):t.ajax({url:o,dataType:r.dataType}).done(function(t){n.processResponse(t,o),r.onSearchComplete.call(n.element,e)}).fail(function(){n.addBadRequest(o)})}},addBadRequest:function(t){this.badQueries.push(t)},isBadQuery:function(t){for(var e=this.badQueries,a=e.length;a--;)if(0===t.indexOf(e[a]))return!0;return!1},hide:function(){var e=this;e.visible=!1,e.selectedIndex=-1,t(e.suggestionsContainer).hide()},suggest:function(){if(0===this.suggestions.length)return this.hide(),void 0;var e=this,a=e.options.formatResult,n=e.getQuery(e.currentValue),r=e.classes.suggestion,o=e.classes.selected,i=t(e.suggestionsContainer),s="";t.each(e.suggestions,function(t,e){s+='<div class="'+r+'" data-index="'+t+'">'+a(e,n)+"</div>"}),i.html(s).show(),e.visible=!0,e.options.autoSelectFirst&&(e.selectedIndex=0,i.children().first().addClass(o))},verifySuggestionsFormat:function(e){return e.length&&"string"==typeof e[0]?t.map(e,function(t){return{value:t,data:null}}):e},processResponse:function(t,e){var a=this,n=a.options,r=n.transformResult(t,e);r.suggestions=a.verifySuggestionsFormat(r.suggestions),n.noCache||(a.cachedResponse[e]=r,0===r.suggestions.length&&a.badQueries.push(e)),a.suggestions=r.suggestions,a.filterSuggestions(a.currentValue),a.suggest()},activate:function(e){var a,n=this,r=n.classes.selected,o=t(n.suggestionsContainer),i=o.children();return o.children("."+r).removeClass(r),n.selectedIndex=e,-1!==n.selectedIndex&&i.length>n.selectedIndex?(a=i.get(n.selectedIndex),t(a).addClass(r),a):null},select:function(t,e){var a=this,n=a.suggestions[t];n&&(a.el.val(n),a.ignoreValueChange=e,a.hide(),a.onSelect(t))},moveUp:function(){var e=this;if(-1!==e.selectedIndex)return 0===e.selectedIndex?(t(e.suggestionsContainer).children().first().removeClass(e.classes.selected),e.selectedIndex=-1,e.el.val(e.currentValue),void 0):(e.adjustScroll(e.selectedIndex-1),void 0)},moveDown:function(){var t=this;t.selectedIndex!==t.suggestions.length-1&&t.adjustScroll(t.selectedIndex+1)},adjustScroll:function(e){var a,n,r,o=this,i=o.activate(e),s=25;i&&(a=i.offsetTop,n=t(o.suggestionsContainer).scrollTop(),r=n+o.options.maxHeight-s,n>a?t(o.suggestionsContainer).scrollTop(a):a>r&&t(o.suggestionsContainer).scrollTop(a-o.options.maxHeight+s),o.el.val(o.getValue(o.suggestions[e].value)))},onSelect:function(e){var a=this,n=a.options.onSelect,r=a.suggestions[e];a.el.val(a.getValue(r.value.replace(/<.+?>/gi,""))),t.isFunction(n)&&n.call(a.element,r)
},getValue:function(t){var e,a,n=this,r=n.options.delimiter;return r?(e=n.currentValue,a=e.split(r),1===a.length?t:e.substr(0,e.length-a[a.length-1].length)+t):t},dispose:function(){var e=this;e.el.off(".autocomplete").removeData("autocomplete"),e.disableKillerFn(),t(e.suggestionsContainer).remove()}},t.fn.autocomplete=function(a,n){var r="autocomplete";return 0===arguments.length?this.first().data(r):this.each(function(){var o=t(this),i=o.data(r);"string"==typeof a?i&&"function"==typeof i[a]&&i[a](n):(i&&i.dispose&&i.dispose(),i=new e(this,a),o.data(r,i))})}}),Mobility.dispatch.on("load.bump",function(t,e){function a(t){return function(e,a){var n=e.probabilities[t][4],r=a.probabilities[t][4];return n>r?-1:r>n?1:n===r?a.probabilities[t][3]-e.probabilities[t][3]:void 0}}var n=30,r={top:5,right:264,bottom:10,left:276},o=945-r.left-r.right,i=16*n-r.top-r.bottom,s=30,l=(o-2*s)/3,c=6,p=4,d=0,u={Bridgeport:"Connecticut",Newark:"Northern N.J.","San Jose":"San Jose, Calif.",Portland:"Portland, Ore.",Providence:"Providence, R.I.","Washington DC":"Washington, D.C.",Fresno:"Fresno, Calif.",Austin:"Austin, Tex.","Port St. Lucie":"Port St. Lucie, Fla.",Tampa:"Tampa, Fla.",Orlando:"Orlando, Fla.",Raleigh:"Raleigh, N.C.",Charlotte:"Charlotte, N.C."};t.sort(function(t,e){return e.population-t.population}),e=t.slice(0,n);var g=d3.scale.linear().domain([0,d3.sum(e,function(t){return t.population})]).range([0,i-n*c]);d3.scale.linear().domain([0,.8*e.length-1,e.length-1]).range(["#fbf8ca","#fbbc78","#ce3a2b"]).interpolate(d3.interpolateHcl).clamp(!0),d3.scale.linear().domain([0,e.length-1]).range(["#aac6b2","#edefc5"]).interpolate(d3.interpolateHcl).clamp(!0),d3.scale.linear().domain([0,e.length-1]).range(["#3079a7","#8eb2b6"]).interpolate(d3.interpolateHcl).clamp(!0),[0,1,2,3,4].forEach(function(t){e.sort(a(t));var n=0;e.forEach(function(e,a){e.ranks[t]=a,e.positions[t]=n+.5*g(e.population),n+=g(e.population)+c})});var h=d3.format("%"),f=d3.select(Mobility.containers.bump),m=f.append("div").classed("g-bump-header",!0);m.append("h4").text("Chances of Ending Up in the Top Fifth, For a Child ...");var v=m.append("div").classed("g-bump-labels",!0);v.append("div").html("<strong>... Raised in the Bottom Fifth</strong><br><label>(parents&rsquo; income less than $25k)</label>").classed("g-bump-label-poor",!0).style("width",l+110+"px").style("left","30px"),v.append("div").html("<strong>... Raised in the Top Fifth</strong><br /><label>(parents&rsquo; income more than $107k)</label>").classed("g-bump-label-rich",!0).style("width",l+110+"px").style("right","30px");var y=f.append("svg").attr("width",o+r.left+r.right).attr("height",i+r.top+r.bottom).append("g").attr("transform","translate("+r.left+","+r.top+")"),b=y.append("g").attr("class","g-legend").attr("transform","translate(-180, 10)");b.selectAll(".g-note").data("Listed best\nto worst".split("\n")).enter().append("text").attr("dy",function(t,e){return 1.3*e+"em"}).text(function(t){return t}).classed("g-text-annotation",!0),b.append("line").attr("x1",60).attr("y1",-10).attr("x2",60).attr("y2",10).style("stroke","#ccc"),b.append("path").attr("d","M60 10l3 0l-3 6l-3 -6z").style("fill","#ccc");var x=y.selectAll(".g-city").data(e.sort(function(t,e){return e.population-t.population})).enter().append("g").attr("class","g-city").style("font-size",function(t){return Math.max(3.7*Math.sqrt(g(t.population)),9)+"px"}).on("mouseover",function(){}).on("mouseout",function(){});x.append("path").attr("class","g-city-line-hover").attr("d",function(t){return"M 0 "+t.positions[d]+"l"+l+" 0"+"L "+(2*l+2*s)+" "+t.positions[p]+"l"+l+" 0"}).style("stroke-width",function(t){return Math.max(g(t.population)+7,1)}),x.append("path").attr("class","g-city-line-halo").attr("d",function(t){return"M 0 "+t.positions[d]+"l"+l+" 0"+"L "+(2*l+2*s)+" "+t.positions[p]+"l"+l+" 0"}).style("stroke-width",function(t){return Math.max(g(t.population)+2,1)}),x.append("path").attr("class","g-city-line").attr("d",function(t){return"M 0 "+t.positions[d]+"l"+l+" 0"+"L "+(2*l+2*s)+" "+t.positions[p]+"l"+l+" 0"}).style("stroke-width",function(t){return Math.max(g(t.population),1)});var v=x.append("g"),C=v.append("text").attr("transform",function(t){return"translate(-8, "+(t.positions[d]+.25*g(t.population))+")"}).attr("class","g-label-left g-label-left-city");C.append("tspan").attr("class","g-rank-label").text(function(t){return"#"+(t.ranks[d]+1)+" of "+n+"  "}),C.append("tspan").text(function(t){return u[t.name]||t.name});var C=v.append("text").attr("transform",function(t){return"translate("+(o+8)+", "+(t.positions[p]+.25*g(t.population))+")"}).attr("class","g-label-right g-label-right-city");C.append("tspan").text(function(t){return u[t.name]||t.name}),C.append("tspan").attr("class","g-rank-label").text(function(t){return"  #"+(t.ranks[p]+1)+" of "+n});var k=v.append("g").attr("class","g-pct").attr("transform","translate(0, 4)");k.append("text").text(function(t){return h(t.probabilities[d][4])}).attr("transform",function(t){return"translate("+l/2+", "+t.positions[d]+")"}),k.append("text").text(function(t){return h(t.probabilities[p][4])}).attr("transform",function(t){return"translate("+(o-l/2)+", "+t.positions[p]+")"}),f.append("div").attr("class","g-note").style("margin-left",r.left-155+"px").text("Lines are scaled by population; the 30 most populous areas are shown.")});